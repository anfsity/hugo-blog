<!-- ================================================================ -->
<!-- 自定义样式 -->
<!-- ================================================================ -->
<style>
    /* 1. 动态目录样式 */
    #TableOfContents > ul,
    #TableOfContents > ol {
        ul,
        ol {
            display: none;
        }
        .open {
            display: block;
        }
    }

    /* 2. 返回顶部按钮样式 */
    {{ with resources.Get "icons/arrow-big-up.svg" }}
    {{ $icon := .Content | base64Encode | safeURL }}
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        z-index: 99;
        cursor: pointer;
        width: 26px;
        height: 26px;
        background-image: url('{{ .Permalink }}');
    }
    {{ end }}

    /* 3. 代码块折叠样式 */
    :root {
        /* 亮色模式下的默认颜色 */
        --code-fade-color: white; 
        --code-btn-bg: #f0f0f5;  
        --code-btn-icon-color: #333; 
    }
    html[data-scheme="dark"] {
        /* 适配 Stack 主题的暗黑模式颜色 */
        --code-fade-color: #2e2e2e;
        --code-btn-bg: #424242;
        --code-btn-icon-color: #c5c5c5;
    }
    .highlight {
        max-height: 400px;
        overflow: hidden;
        position: relative;
        transition: max-height 0.3s ease-in-out;
    }
    .highlight.code-show {
        max-height: none !important;
    }
    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: linear-gradient(to bottom, transparent, var(--code-fade-color));
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
        transition: background-image 0.3s;
        pointer-events: none; /* 让遮罩本身不响应点击 */
    }
    .highlight.code-show .code-more-box {
        background-image: none;
    }
    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: var(--code-btn-bg);
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
        position: relative;
        z-index: 2;
        transition: background-color 0.3s;
        pointer-events: auto; /* 确保按钮可以被点击 */
    }
    .code-more-img {
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
        color: var(--code-btn-icon-color);
        stroke: currentColor;
    }
</style>

<!-- ================================================================ -->
<!-- 自定义脚本 -->
<!-- ================================================================ -->
<script>
    // 确保在整个文档加载完毕后再执行所有脚本
    document.addEventListener("DOMContentLoaded", function() {

        // --- 功能一：动态目录 ---
        function initTocHide() {
            const toc = document.querySelector(".widget--toc");
            if (!toc) return;

            window.addEventListener('scroll', function() {
                const openUls = document.querySelectorAll("#TableOfContents .open");
                openUls.forEach(ul => ul.classList.remove("open"));

                const currentLi = document.querySelector("#TableOfContents .active-class");
                if (!currentLi) return;

                if (currentLi.children.length > 1 && currentLi.children[1].matches('ul, ol')) {
                    currentLi.children[1].classList.add("open");
                }

                let parentUl = currentLi.parentElement;
                while (parentUl && parentUl.closest('#TableOfContents')) {
                    if (parentUl.matches('ul, ol')) {
                        parentUl.classList.add("open");
                    }
                    if (parentUl.parentElement && parentUl.parentElement.tagName === 'LI') {
                        parentUl = parentUl.parentElement.parentElement;
                    } else {
                        break;
                    }
                }
            }, { passive: true }); // 使用 passive listener 提升滚动性能
        }

        // --- 功能二：返回顶部 ---
        function initScrollTop() {
            const rightSideBar = document.querySelector(".right-sidebar");
            if (!rightSideBar) return;

            const btn = document.createElement("div");
            btn.id = "backTopBtn";
            btn.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });
            rightSideBar.appendChild(btn);

            window.addEventListener('scroll', function() {
                if (window.scrollY > 20) {
                    btn.style.display = "block";
                } else {
                    btn.style.display = "none";
                }
            }, { passive: true });
        }

        // --- 功能三：代码块折叠 ---
        function initCodeMoreBox() {
            const codeBlocks = document.querySelectorAll(".highlight");
            if (!codeBlocks.length) return;

            // 使用 Base64 内联 SVG，避免资源加载问题
            let moreIconSrc = '';
            let lessIconSrc = '';

            {{ with resources.Get "icons/caret-down.svg" }}
                {{ $iconContent := .Content | base64Encode }}
                moreIconSrc = 'data:image/svg+xml;base64,{{ $iconContent }}';
            {{ end }}

            {{ with resources.Get "icons/caret-up.svg" }}
                {{ $iconContent := .Content | base64Encode }}
                lessIconSrc = 'data:image/svg+xml;base64,{{ $iconContent }}';
            {{ end }}

            codeBlocks.forEach(codeBlock => {
                // 使用 offsetHeight, 它考虑了边框和内边距，更准确
                if (codeBlock.scrollHeight <= codeBlock.offsetHeight) return;

                const codeMoreBox = document.createElement('div');
                codeMoreBox.classList.add('code-more-box');
                
                const codeMoreBtn = document.createElement('span');
                codeMoreBtn.classList.add('code-more-btn');
                
                const img = document.createElement('img');
                img.classList.add('code-more-img');
                img.src = moreIconSrc;
                img.setAttribute('alt', 'Expand code block'); // 增加可访问性

                codeMoreBtn.addEventListener('click', () => {
                    codeBlock.classList.toggle('code-show');
                    const isShown = codeBlock.classList.contains('code-show');
                    img.src = isShown ? lessIconSrc : moreIconSrc;
                    img.setAttribute('alt', isShown ? 'Collapse code block' : 'Expand code block');
                    
                    // 触发 resize 事件，帮助其他组件（如目录）重新计算位置
                    window.dispatchEvent(new Event('resize'));
                });

                codeMoreBtn.appendChild(img);
                codeMoreBox.appendChild(codeMoreBtn);
                codeBlock.appendChild(codeMoreBox);
            });
        }

        // --- 统一调用所有初始化函数 ---
        try {
            initTocHide();
            initScrollTop();
            initCodeMoreBox();
        } catch (e) {
            console.error("Error initializing custom scripts:", e);
        }
    });
</script>
